<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Heart to Heart | ISA Chulalongkorn</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400&family=Pinyon+Script&display=swap');

    :root{
      --gold:#c5a059;
      --deep-green:#1a2a1d;
      --cream:#f8f5f0;
      --blush:#e8d5d1;
    }

    html,body{
      width:100%;
      height:100%;
      margin:0;
      padding:0;
      background:var(--cream);
      overflow:hidden;
      -webkit-text-size-adjust:100%;
      touch-action:manipulation;
    }

    body{
      min-height:100svh;
      background-color:var(--cream);
      color:var(--deep-green);
      font-family:'Lato',sans-serif;
      display:flex;
      justify-content:center;
      align-items:center;
      transition:background-color 2s ease;
      position:relative;
    }

    #app-container{
      text-align:center;
      width:100%;
      max-width:1200px;
      padding:20px;
      z-index:10;
      box-sizing:border-box;
      position:relative;
    }

    /* =========================
       SECRET GARDEN BACKGROUND
       ========================= */
    .garden-bg{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      overflow:hidden;
      background:
        radial-gradient(900px 700px at 20% 20%, rgba(197,160,89,0.14), transparent 60%),
        radial-gradient(800px 650px at 80% 30%, rgba(232,213,209,0.18), transparent 55%),
        radial-gradient(900px 700px at 40% 90%, rgba(26,42,29,0.14), transparent 55%),
        linear-gradient(120deg, rgba(248,245,240,1), rgba(248,245,240,1));
    }
    .garden-bg::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.55), transparent 55%),
        radial-gradient(circle at 70% 40%, rgba(255,255,255,0.35), transparent 60%),
        radial-gradient(circle at 50% 70%, rgba(255,255,255,0.25), transparent 65%),
        linear-gradient(120deg, rgba(197,160,89,0.08), rgba(232,213,209,0.10), rgba(26,42,29,0.06));
      filter:blur(18px);
      opacity:0.9;
      animation:gardenDrift 18s ease-in-out infinite;
      transform:translate3d(0,0,0);
    }
    .garden-bg::after{
      content:"";
      position:absolute;
      inset:0;
      background-image:url("https://www.transparenttextures.com/patterns/natural-paper.png");
      opacity:0.55;
      mix-blend-mode:multiply;
    }
    @keyframes gardenDrift{
      0%{transform:translate(-4%,-2%) rotate(-2deg);}
      50%{transform:translate(4%,2%) rotate(2deg);}
      100%{transform:translate(-4%,-2%) rotate(-2deg);}
    }

    /* =========================
       PETALS
       ========================= */
    .petals{
      position:fixed;
      inset:0;
      z-index:2;
      pointer-events:none;
      overflow:hidden;
    }
    .petal{
      position:absolute;
      top:-10%;
      width:10px;
      height:16px;
      border-radius:60% 40% 60% 40%;
      background:rgba(232,213,209,0.55);
      box-shadow:0 0 0 1px rgba(197,160,89,0.08);
      filter:blur(0.15px);
      animation:fall linear infinite;
      transform:rotate(12deg);
      opacity:0.85;
    }
    @keyframes fall{
      0%{transform:translate3d(0,-20px,0) rotate(10deg);}
      100%{transform:translate3d(0,120vh,0) rotate(260deg);}
    }

    /* =========================
       BIRDS
       ========================= */
    .birds{
      position:fixed;
      inset:0;
      z-index:3;
      pointer-events:none;
      overflow:hidden;
      opacity:0.65;
      filter:blur(0.1px);
    }
    .bird{
      position:absolute;
      left:0;
      top:0;
      width:56px;
      height:30px;
      opacity:0.55;
      animation:flyDiag linear infinite;
      transform:translate3d(var(--fromX),var(--fromY),0) scale(var(--s,1));
      will-change:transform,opacity;
    }
    @keyframes flyDiag{
      0%{transform:translate3d(var(--fromX),var(--fromY),0) scale(var(--s,1)); opacity:0;}
      10%{opacity:0.65;}
      90%{opacity:0.55;}
      100%{transform:translate3d(var(--toX),var(--toY),0) scale(var(--s,1)); opacity:0;}
    }
    .bird .wing{transform-box:fill-box; transform-origin:center; animation:flap 0.35s ease-in-out infinite;}
    .bird .wing.right{animation-delay:0.02s;}
    @keyframes flap{
      0%{transform:rotate(8deg) scaleY(1);}
      50%{transform:rotate(-18deg) scaleY(0.92);}
      100%{transform:rotate(8deg) scaleY(1);}
    }

    .vignette{
      position:fixed; inset:0;
      background:radial-gradient(circle, transparent 50%, rgba(26,42,29,0.1));
      pointer-events:none; z-index:5;
    }
    .botanical{position:fixed; width:450px; opacity:0.12; pointer-events:none; z-index:3;}
    .top-left{top:-120px; left:-120px; transform:rotate(15deg);}
    .bottom-right{bottom:-120px; right:-120px; transform:rotate(195deg);}

    /* =========================
       HEADERS
       ========================= */
    .isa-tag{
      font-size:0.6rem;
      letter-spacing:3px;
      margin-bottom:8px;
      opacity:0.7;
      text-transform:uppercase;
    }
    h1.main-title{
      font-family:'Pinyon Script',cursive;
      font-size:clamp(3rem,12vw,6rem);
      color:var(--gold);
      margin:0;
      line-height:1.1;
    }
    .sub-theme{
      font-family:'Playfair Display',serif;
      font-size:clamp(0.7rem,2vw,1rem);
      letter-spacing:clamp(4px,1vw,10px);
      text-transform:uppercase;
      margin-bottom:clamp(20px,5vh,50px);
    }

    /* =========================
       DECK
       ========================= */
    .deck-area{
      position:relative;
      height:clamp(250px,40vh,400px);
      width:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      perspective:1000px;
    }
    .card{
      position:absolute;
      width:clamp(120px,25vw,180px);
      height:clamp(170px,35vh,260px);
      background:#fff;
      border-radius:4px;
      box-shadow:0 10px 30px rgba(0,0,0,0.1);
      cursor:pointer;
      transition:all 0.8s cubic-bezier(0.2,1,0.3,1);
      overflow:hidden;
    }
    .card::after{
      content:'';
      position:absolute;
      inset:8px;
      border:1px solid var(--gold);
      background-color:var(--deep-green);
      background-image:url("https://www.transparenttextures.com/patterns/dark-matter.png");
    }
    .card-crest{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      color:var(--gold);
      font-family:'Playfair Display',serif;
      font-size:2rem;
      z-index:2;
      opacity:0.6;
      pointer-events:none;
    }

    /* =========================
       RESULT
       ========================= */
    #result-screen{display:none; opacity:0; transition:opacity .6s ease;}

    #capture-frame{
      background:#fff;
      padding:clamp(26px,4.5vw,56px) clamp(18px,4vw,40px);
      width:min(92vw, 420px);
      margin:0 auto;
      position:relative;
      box-sizing:border-box;
      border:1px solid rgba(197,160,89,0.2);
      box-shadow:0 30px 60px rgba(0,0,0,0.05);
      background-image:url("https://www.transparenttextures.com/patterns/paper-fibers.png");
    }
    #capture-frame::before{
      content:"";
      position:absolute;
      inset:14px;
      border:0.5px solid var(--gold);
      pointer-events:none;
    }

    .result-isa{
      font-size:0.55rem;
      letter-spacing:4px;
      text-transform:uppercase;
      color:var(--gold);
      display:block;
      margin-bottom:18px;
    }

    .result-theme{
      font-family:'Pinyon Script',cursive;
      font-size:2.8rem;
      color:var(--deep-green);
      margin:0;
      line-height:1.02;
    }

    .quote-box{
      font-family:'Playfair Display',serif;
      font-size:clamp(1.15rem, 4.2vw, 1.85rem);
      line-height:1.38;
      margin:22px 0 18px;
      font-style:italic;
    }
    .quote-author{
      font-family:'Lato',sans-serif;
      font-size:0.72rem;
      letter-spacing:3px;
      text-transform:uppercase;
      opacity:0.6;
    }

    .recommendation{
      display:flex;
      justify-content:space-between;
      gap:14px;
      margin-top:22px;
      padding-top:16px;
      border-top:0.5px solid rgba(0,0,0,0.1);
      text-align:left;
    }
    .rec-label{
      font-size:0.5rem;
      letter-spacing:2px;
      text-transform:uppercase;
      color:var(--gold);
      display:block;
    }
    .rec-val{font-family:'Playfair Display',serif; font-size:0.95rem;}

    /* =========================
       CARD CANVAS (CAPTURED)
       ========================= */
    .card-canvas{
      position:relative;
      width:100%;
      margin:16px auto 10px;
      border-radius:14px;
      overflow:hidden; /* CLIP to card borders */
      border:1px solid rgba(197,160,89,0.25);
      background:rgba(255,255,255,0.6);
      aspect-ratio: 4 / 5;
      max-height: 52vh;
      touch-action:none; /* makes pointer dragging stable */
    }

    .photo-frame{
      position:absolute;
      left:7.5%;
      right:7.5%;
      top:10%;
      height:46%;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(197,160,89,0.25);
      background:rgba(255,255,255,0.72);
      box-shadow:0 10px 22px rgba(0,0,0,0.04);
    }
    .photo-frame img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

/* =========================
   MODE STYLING 
   ========================= */

/* Hybrid: show photo frame */
.card-canvas[data-mode="hybrid"] .photo-frame { display:block; }

/* Decor-only: hide photo frame completely */
.card-canvas[data-mode="decor"] .photo-frame { display:none !important; }

/* Decor-only: full-card background (NO inner panel / NO cut-out zone) */
.card-canvas[data-mode="decor"]{
  background:
    radial-gradient(700px 520px at 20% 15%, rgba(197,160,89,0.14), transparent 60%),
    radial-gradient(680px 520px at 80% 28%, rgba(232,213,209,0.20), transparent 58%),
    radial-gradient(760px 620px at 45% 90%, rgba(26,42,29,0.10), transparent 62%),
    rgba(255,255,255,0.72);
}

/* Optional: subtle paper texture over the whole canvas */
.card-canvas[data-mode="decor"]::before{
  content:"";
  position:absolute;
  inset:0;
  background-image:url("https://www.transparenttextures.com/patterns/natural-paper.png");
  opacity:0.35;
  mix-blend-mode:multiply;
  pointer-events:none;
}

/* Remove any ‚Äúphoto panel‚Äù / crest box look */
.card-canvas[data-mode="decor"]::after{ content:none !important; }
/* =========================
   STICKER LAYER
   ========================= */
.decor-layer{
  position:absolute;
  inset:0;
  pointer-events:auto;
  z-index:3; /* keep above background */
}

.sticker{
  position:absolute;
  left:50%;
  top:50%;
  transform: translate(-50%,-50%) rotate(0deg) scale(1);
  transform-origin: center;
  user-select:none;
  touch-action:none;
  filter:drop-shadow(0 8px 10px rgba(0,0,0,0.08));
  cursor:grab;
  z-index:4;
  will-change: transform, left, top;
}
.sticker:active{ cursor:grabbing; }

/* =========================
   MODE STYLING 
   ========================= */

/* Hybrid: show photo frame */
.card-canvas[data-mode="hybrid"] .photo-frame { display:block; }

/* Decor-only: hide photo frame completely */
.card-canvas[data-mode="decor"] .photo-frame { display:none !important; }

/* Decor-only: still keep the SAME canvas size + clipping */
.card-canvas[data-mode="decor"]{
  /* KEEP the canvas geometry so dragging works */
  overflow:hidden;             /* clip to card borders */
  border-radius:14px;
  border:1px solid rgba(197,160,89,0.25);
  aspect-ratio: 4 / 5;
  max-height: 52vh;

  /* Just change the look (no inner photo panel) */
  background:
    radial-gradient(700px 520px at 20% 15%, rgba(197,160,89,0.14), transparent 60%),
    radial-gradient(680px 520px at 80% 28%, rgba(232,213,209,0.20), transparent 58%),
    radial-gradient(760px 620px at 45% 90%, rgba(26,42,29,0.10), transparent 62%),
    rgba(255,255,255,0.72);
}

/* Optional paper texture over the whole canvas */
.card-canvas[data-mode="decor"]::before{
  content:"";
  position:absolute;
  inset:0;
  background-image:url("https://www.transparenttextures.com/patterns/natural-paper.png");
  opacity:0.35;
  mix-blend-mode:multiply;
  pointer-events:none;
}

/* Remove any pseudo decorations you don't want */
.card-canvas[data-mode="decor"]::after{ content:none !important; }

    /* =========================
       BUTTONS / CONTROLS
       ========================= */
    .btn-group{
      margin-top:22px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      background:none;
      border:1px solid var(--gold);
      padding:10px 18px;
      font-family:'Lato',sans-serif;
      text-transform:uppercase;
      letter-spacing:2px;
      font-size:0.7rem;
      cursor:pointer;
      transition:0.3s;
      backdrop-filter:blur(4px);
      flex:1 1 auto;
      min-width:120px;
      max-width:200px;
    }
    .btn-save{background:var(--gold); color:#fff;}
    .btn-save:hover{background:var(--deep-green); border-color:var(--deep-green);}
    .btn-sound{
      border-color:rgba(197,160,89,0.65);
      color:var(--deep-green);
      background:rgba(255,255,255,0.45);
    }
    .btn-sound.active{
      background:rgba(26,42,29,0.85);
      color:#fff;
      border-color:rgba(26,42,29,0.85);
    }

    .decorate-panel{
      margin-top:14px;
      display:grid;
      gap:10px;
      justify-items:center;
    }
    .decorate-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
    }
    .pill{
      border:1px solid rgba(197,160,89,0.55);
      background:rgba(255,255,255,0.55);
      backdrop-filter:blur(4px);
      border-radius:999px;
      padding:8px 12px;
      font-size:0.7rem;
      letter-spacing:1px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      max-width:92vw;
    }
    .pill input[type="file"]{font-size:0.65rem; max-width:44vw;}
    .pill input[type="range"]{width:140px; max-width:40vw;}
    select{font:inherit;}

/* ===== MODE B: ABSOLUTELY NO BORDER, NO FRAME ===== */
.card-canvas[data-mode="decor"]{
  border: none !important;
  border-radius: 0 !important;
  box-shadow: none !important;
}

/* Kill any pseudo-borders / overlays */
.card-canvas[data-mode="decor"]::before,
.card-canvas[data-mode="decor"]::after{
  content: none !important;
}

</style>
</head>

<body>
  <div class="garden-bg"></div>
  <div class="petals" id="petals"></div>
  <div class="birds" id="birds"></div>
  <div class="vignette"></div>

  <img src="https://www.transparenttextures.com/patterns/flowers.png" class="botanical top-left" alt="" />
  <img src="https://www.transparenttextures.com/patterns/flowers.png" class="botanical bottom-right" alt="" />

  <div id="app-container">
    <div id="ritual-screen">
      <p class="isa-tag">ISA Chulalongkorn Presents</p>
      <h1 class="main-title">Heart to Heart</h1>
      <p class="sub-theme">The Secret Garden</p>

      <div class="deck-area" id="deck-container"></div>
      <p id="status-text" style="margin-top: 40px; font-size: 0.7rem; letter-spacing: 3px; text-transform: uppercase;">
        Tap the deck to begin
      </p>

      <div class="btn-group" style="margin-top:18px;">
        <button class="btn btn-sound active" id="soundBtn" type="button">Sound: On</button>
      </div>
      <p style="font-size:0.6rem; opacity:0.55; letter-spacing:1px; margin-top:10px;">
        (Sound will begin on your first tap/click.)
      </p>
    </div>

    <div id="result-screen">
      <div id="capture-frame">
        <span class="result-isa">ISA Chulalongkorn</span>
        <h2 class="result-theme">Heart to Heart</h2>

        <div id="cardCanvas" class="card-canvas" data-mode="decor">
          <div id="photoFrame" class="photo-frame">
            <img id="userPhoto" alt="Your photo" />
          </div>
          <div id="decorLayer" class="decor-layer"></div>
        </div>

        <div class="quote-box" id="quote-text"></div>
        <div class="quote-author" id="quote-source"></div>

        <div class="recommendation">
          <div>
            <span class="rec-label">Cinematic</span>
            <span class="rec-val" id="movie-title"></span>
          </div>
          <div>
            <span class="rec-label">Literary</span>
            <span class="rec-val" id="book-title"></span>
          </div>
        </div>
      </div>

      <div class="decorate-panel">
        <div class="decorate-row">
          <div class="pill">
            Mode:
            <select id="modeSelect">
              <option value="decor" selected>Mode B ‚Äî Emojis Only</option>
              <option value="hybrid">Mode A ‚Äî Photo + Emojis</option>
            </select>
          </div>

          <div class="pill" id="photoInputWrap" style="display:none;">
            Add Photo:
            <input id="photoInput" type="file" accept="image/*" />
          </div>

          <div class="pill">
            Symbol:
            <select id="stickerSelect">
              <option value="üíå">üíå Love Letter</option>
              <option value="‚ù£Ô∏è">‚ù£Ô∏è Heart Exclamation</option>
              <option value="ü©∑" selected>ü©∑ Heart</option>
              <option value="‚ù§Ô∏è">‚ù§Ô∏è Red Heart</option>
              <option value="üß°">üß° Orange Heart</option>
              <option value="üíõ">üíõ Yellow Heart</option>
              <option value="üíö">üíö Green Heart</option>
              <option value="üíô">üíô Blue Heart</option>
              <option value="ü©µ">ü©µ Light Blue Heart</option>
              <option value="üíú">üíú Purple Heart</option>
              <option value="ü§é">ü§é Brown Heart</option>
              <option value="üñ§">üñ§ Black Heart</option>
              <option value="ü©∂">ü©∂ Grey Heart</option>
              <option value="ü§ç">ü§ç White Heart</option>
              <option value="‚ú®">‚ú® Sparkle</option>
              <option value="üí´">üí´ Twinkle</option>
              <option value="ü´ß">ü´ß Bubbles</option>
              <option value="üéÄ">üéÄ Ribbon</option>
              <option value="ü™Ω">ü™Ω Wings</option>
              <option value="‚≠ê">‚≠ê Star</option>
              <option value="‚òÅÔ∏è">‚òÅÔ∏è Cloud</option>
            </select>
          </div>

          <div class="pill">
            Size:
            <input id="stickerSize" type="range" min="16" max="96" value="34" />
          </div>
        </div>

        <div class="decorate-row">
          <button class="btn" id="placeStickerBtn" type="button">Place Sticker</button>
          <button class="btn" id="clearStickersBtn" type="button">Clear</button>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn" id="resetBtn" type="button">Reset</button>
        <button class="btn btn-save" id="saveBtn" type="button">Save Picture</button>
        <button class="btn btn-sound active" id="soundBtn2" type="button">Sound: On</button>
      </div>
    </div>
  </div>

<script>
  /* =========================
     PETALS
     ========================= */
  const petalsHost = document.getElementById('petals');
  function spawnPetals(count = 16) {
    petalsHost.innerHTML = '';
    for (let i = 0; i < count; i++) {
      const p = document.createElement('div');
      p.className = 'petal';
      const left = Math.random() * 100;
      const dur = 10 + Math.random() * 12;
      const delay = Math.random() * 8;
      const size = 8 + Math.random() * 10;
      p.style.left = left + 'vw';
      p.style.animationDuration = dur + 's';
      p.style.animationDelay = delay + 's';
      p.style.width = size + 'px';
      p.style.height = (size * 1.5) + 'px';
      p.style.opacity = (0.45 + Math.random() * 0.45).toFixed(2);
      petalsHost.appendChild(p);
    }
  }
  spawnPetals(18);
  window.addEventListener('resize', () => spawnPetals(window.innerWidth < 480 ? 12 : 18));

  /* =========================
     SOUND (birds only)
     ========================= */
  let audioCtx = null;
  let masterGain = null;
  let soundOn = true;
  let audioPrimed = false;

  function ensureAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.0001;
    masterGain.connect(audioCtx.destination);
  }

  async function primeAndApplyAudio() {
    ensureAudio();
    if (audioCtx.state === "suspended") {
      try { await audioCtx.resume(); } catch (e) {}
    }
    audioPrimed = true;

    const now = audioCtx.currentTime;
    masterGain.gain.cancelScheduledValues(now);
    masterGain.gain.setValueAtTime(masterGain.gain.value, now);
    masterGain.gain.exponentialRampToValueAtTime(soundOn ? 0.85 : 0.0001, now + 0.12);
    updateSoundButtons();
  }

  function setSound(on) {
    soundOn = on;
    if (!audioPrimed || !audioCtx || !masterGain) { updateSoundButtons(); return; }
    const now = audioCtx.currentTime;
    masterGain.gain.cancelScheduledValues(now);
    masterGain.gain.setValueAtTime(masterGain.gain.value, now);
    masterGain.gain.exponentialRampToValueAtTime(on ? 0.85 : 0.0001, now + 0.12);
    updateSoundButtons();
  }

  function toggleSound() { setSound(!soundOn); }

  function updateSoundButtons() {
    const label = soundOn ? "Sound: On" : "Sound: Off";
    const btns = [document.getElementById("soundBtn"), document.getElementById("soundBtn2")].filter(Boolean);
    btns.forEach(b => {
      b.textContent = label;
      b.classList.toggle("active", soundOn);
    });
  }

  (function bindAutoStart() {
    const once = async () => {
      await primeAndApplyAudio();
      window.removeEventListener("pointerdown", once);
      window.removeEventListener("keydown", once);
    };
    window.addEventListener("pointerdown", once);
    window.addEventListener("keydown", once);
  })();

  document.getElementById("soundBtn").addEventListener("click", (e) => {
    e.stopPropagation();
    toggleSound();
  });

  function pleasantChirp({ pan = 0, volume = 1 } = {}) {
    if (!audioCtx || !audioPrimed || !soundOn) return;

    const now = audioCtx.currentTime;
    const osc1 = audioCtx.createOscillator();
    const osc2 = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();
    const panner = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : null;

    osc1.type = "sine";
    osc2.type = "triangle";
    filter.type = "bandpass";
    filter.frequency.value = 2600;
    filter.Q.value = 9;

    const base = 1350 + Math.random() * 950;
    const sweepUp = 1.30 + Math.random() * 0.30;
    const duration = 0.18 + Math.random() * 0.08;

    osc1.frequency.setValueAtTime(base, now);
    osc1.frequency.exponentialRampToValueAtTime(base * sweepUp, now + duration * 0.65);
    osc2.frequency.setValueAtTime(base * 0.985, now);
    osc2.frequency.exponentialRampToValueAtTime(base * sweepUp * 1.02, now + duration * 0.65);

    const lfo = audioCtx.createOscillator();
    const lfoGain = audioCtx.createGain();
    lfo.type = "sine";
    lfo.frequency.value = 10 + Math.random() * 3;
    lfoGain.gain.value = 14 + Math.random() * 9;
    lfo.connect(lfoGain);
    lfoGain.connect(osc1.frequency);
    lfoGain.connect(osc2.frequency);

    const peak = 0.045 * volume;
    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(peak, now + 0.028);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);

    osc1.connect(filter);
    osc2.connect(filter);

    if (panner) {
      panner.pan.setValueAtTime(Math.max(-1, Math.min(1, pan)), now);
      filter.connect(panner);
      panner.connect(gain);
    } else {
      filter.connect(gain);
    }
    gain.connect(masterGain);

    lfo.start(now);
    osc1.start(now);
    osc2.start(now);

    const stopAt = now + duration + 0.02;
    lfo.stop(stopAt);
    osc1.stop(stopAt);
    osc2.stop(stopAt);
  }

  updateSoundButtons();

  /* =========================
     BIRDS (visual + sound synced)
     ========================= */
  const birdsHost = document.getElementById('birds');

  function spawnBird() {
    if (!birdsHost) return;

    const bird = document.createElement('div');
    bird.className = 'bird';

    const mode = Math.random() > 0.5 ? "up" : "down";
    const fromX = "-25vw";
    const toX   = "120vw";

    const fromY = mode === "up"
      ? (65 + Math.random() * 25) + "vh"
      : (10 + Math.random() * 25) + "vh";

    const toY = mode === "up"
      ? (8 + Math.random() * 25) + "vh"
      : (55 + Math.random() * 30) + "vh";

    const dur = 9 + Math.random() * 10;
    const delay = Math.random() * 2.5;
    const scale = (0.75 + Math.random() * 0.7).toFixed(2);
    const opacity = (0.28 + Math.random() * 0.35).toFixed(2);

    bird.style.setProperty('--fromX', fromX);
    bird.style.setProperty('--toX', toX);
    bird.style.setProperty('--fromY', fromY);
    bird.style.setProperty('--toY', toY);
    bird.style.setProperty('--s', scale);
    bird.style.animationDuration = dur + "s";
    bird.style.animationDelay = delay + "s";
    bird.style.opacity = opacity;

    bird.innerHTML = `
      <svg viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg">
        <g fill="none" stroke-linecap="round" stroke="rgba(26,42,29,0.62)">
          <path d="M58 36 Q60 34 62 36" stroke-width="3"/>
          <path class="wing left"  d="M60 36 Q40 18 18 26" stroke-width="3.2"/>
          <path class="wing right" d="M60 36 Q80 18 102 26" stroke-width="3.2"/>
        </g>
        <g fill="none" stroke-linecap="round" stroke="rgba(197,160,89,0.28)">
          <path class="wing left"  d="M60 36 Q43 22 22 28" stroke-width="2.1"/>
          <path class="wing right" d="M60 36 Q77 22 98 28" stroke-width="2.1"/>
        </g>
      </svg>
    `;

    birdsHost.appendChild(bird);

    const entryPan = -0.55 + Math.random() * 0.25;
    const midPan   = -0.10 + Math.random() * 0.20;
    const baseVol = 0.85 + Math.random() * 0.25;

    setTimeout(() => {
      pleasantChirp({ pan: entryPan, volume: baseVol });
      if (Math.random() > 0.55) {
        setTimeout(() => pleasantChirp({ pan: midPan, volume: baseVol * 0.92 }), (dur * 0.45) * 1000);
      }
      if (Math.random() > 0.7) {
        setTimeout(() => pleasantChirp({ pan: entryPan, volume: baseVol * 0.72 }), 220 + Math.random() * 180);
      }
    }, delay * 1000);

    setTimeout(() => bird.remove(), (dur + delay + 1) * 1000);
  }

  function startBirdFlights() {
    spawnBird();
    setInterval(() => { if (Math.random() > 0.35) spawnBird(); }, 2200);
  }
  startBirdFlights();

  /* =========================
     CARDS + REVEAL
     ========================= */
  const colorPalette = [
    { name:"Ivory Silk", hex:"#fffdf0", quote:"To love at all is to be vulnerable.", source:"C.S. Lewis", movie:"Shadowlands", book:"The Four Loves" },
    { name:"Vintage Champagne", hex:"#f5ead0", quote:"Love is not blind; it sees more, not less.", source:"Erich Fromm", movie:"In the Mood for Love", book:"A Lover's Discourse" },
    { name:"Tudor Rose", hex:"#fce3e3", quote:"Everything that frightens us is something helpless that wants our love.", source:"Rainer Maria Rilke", movie:"The Shape of Water", book:"Letters to a Young Poet" },
    { name:"English Lavender", hex:"#e8e1f5", quote:"It is not necessary to hurry intimacy.", source:"Anne Carson", movie:"Before Sunset", book:"Eros the Bittersweet" },
    { name:"Versailles Sage", hex:"#e2ede4", quote:"The world is full of magic things, patiently waiting for our senses to grow sharper.", source:"W.B. Yeats", movie:"Song of the Sea", book:"The Wind Among the Reeds" },
    { name:"Gilded Moss", hex:"#ecebbd", quote:"The only way to make sense out of change is to plunge into it.", source:"Alan Watts", movie:"Spring, Summer, Fall, Winter... and Spring", book:"The Wisdom of Insecurity" },
    { name:"Biedermeier Blue", hex:"#e0f0f5", quote:"Loneliness is the poverty of self; solitude is the richness of self.", source:"May Sarton", movie:"Lost in Translation", book:"Journal of a Solitude" },
    { name:"Old Manor Taupe", hex:"#ede6e1", quote:"Acceptance is a small, quiet room.", source:"Cheryl Strayed", movie:"Nomadland", book:"Tiny Beautiful Things" },
    { name:"Terracotta Sundial", hex:"#f5e6d3", quote:"Beauty is in things imperfect, impermanent, and incomplete.", source:"Leonard Koren", movie:"Arrietty", book:"The Beauty of the Ordinary" },
    { name:"Slate Manor", hex:"#e1e6e8", quote:"Love is the extremely difficult realization that something other than oneself is real.", source:"Iris Murdoch", movie:"Eternal Sunshine of the Spotless Mind", book:"The Sovereignty of Good" },
    { name:"Linen Prayer", hex:"#fcfaf7", quote:"Love is not a relationship between one person and another, but a relationship between a person and love itself.", source:"S√∏ren Kierkegaard", movie:"Still Walking", book:"Works of Love" },
    { name:"Orchard Ash", hex:"#f0f0f0", quote:"Love, by its very nature, is unworldly.", source:"Hannah Arendt", movie:"A Hidden Life", book:"The Human Condition" },
    { name:"Cemetery Stone", hex:"#e3e3e3", quote:"To be alone is to be with the world without intermediaries.", source:"Maurice Blanchot", movie:"Taste of Cherry", book:"The Space of Literature" },
    { name:"Pale Concrete", hex:"#ededeb", quote:"Nothing is missing. Something is simply not added.", source:"Gilles Deleuze", movie:"Columbus", book:"Negotiations" },
    { name:"Oat Chapel", hex:"#f3eddc", quote:"Love is an act of faith, and whoever is of little faith is also of little love.", source:"Erich Fromm", movie:"Ordet", book:"The Art of Loving" },
    { name:"Ash Rose", hex:"#e6dede", quote:"Grief is the final manifestation of love.", source:"Joan Didion", movie:"Aftersun", book:"Blue Nights" }
  ];

  const deck = document.getElementById('deck-container');
  const status = document.getElementById('status-text');
  let shuffleState = 0;

  function createDeck() {
    for (let i = 0; i < 12; i++) {
      const card = document.createElement('div');
      card.className = 'card';
      card.style.zIndex = i;
      card.innerHTML = '<div class="card-crest">‚ù¶</div>';
      card.style.transform = `translate(${i * 0.5}px, ${i * 0.5}px)`;
      card.onclick = () => {
        if (shuffleState < 3) runShuffle();
        else if (shuffleState === 4) revealCard();
      };
      deck.appendChild(card);
    }
  }

  function runShuffle() {
    shuffleState++;
    const cards = document.querySelectorAll('.card');
    cards.forEach((card) => {
      const rx = (Math.random() - 0.5) * 400;
      const ry = (Math.random() - 0.5) * 400;
      const rr = (Math.random() - 0.5) * 100;
      card.style.transform = `translate(${rx}px, ${ry}px) rotate(${rr}deg)`;
    });
    status.innerText = `Shuffling Intentions... (${shuffleState}/3)`;
    setTimeout(() => {
      cards.forEach((card, i) => card.style.transform = `translate(${i * 0.3}px, ${i * 0.3}px) rotate(0deg)`);
      if (shuffleState === 3) setTimeout(fanCards, 600);
    }, 800);
  }

  function fanCards() {
    const cards = document.querySelectorAll('.card');
    shuffleState = 4;
    status.innerText = "Draw your heart's secret";

    const windowWidth = window.innerWidth;
    let spread, angleStep;

    if (windowWidth < 480) { spread = 22; angleStep = 5; }
    else if (windowWidth < 1024) { spread = 35; angleStep = 7; }
    else { spread = 45; angleStep = 9; }

    cards.forEach((card, i) => {
      const centerOffset = (cards.length - 1) / 2;
      const angle = (i - centerOffset) * angleStep;
      const x = (i - centerOffset) * spread;
      const y = windowWidth < 480 ? 10 : 20;
      card.style.transform = `translate(${x}px, ${y}px) rotate(${angle}deg)`;
    });
  }

  function revealCard() {
    const data = colorPalette[Math.floor(Math.random() * colorPalette.length)];
    document.getElementById('ritual-screen').style.opacity = '0';
    document.body.style.backgroundColor = data.hex;

    setTimeout(() => {
      document.getElementById('ritual-screen').style.display = 'none';
      document.getElementById('result-screen').style.display = 'block';

      document.getElementById('quote-text').innerText = data.quote;
      document.getElementById('quote-source').innerText = `‚Äî ${data.source}`;
      document.getElementById('movie-title').innerText = data.movie;
      document.getElementById('book-title').innerText = data.book;

      setTimeout(() => { document.getElementById('result-screen').style.opacity = '1'; }, 60);

      const b2 = document.getElementById('soundBtn2');
      if (b2 && !b2.dataset.bound) {
        b2.dataset.bound = "1";
        b2.addEventListener('click', (e) => { e.stopPropagation(); toggleSound(); });
        updateSoundButtons();
      }
    }, 900);
  }

  /* =========================
     SAVE / RESET
     ========================= */
  function saveImage() {
    const captureArea = document.getElementById('capture-frame');
    html2canvas(captureArea, { backgroundColor: null, scale: 2 }).then(canvas => {
      const link = document.createElement('a');
      link.download = 'HeartToHeart_ISA.png';
      link.href = canvas.toDataURL("image/png");
      link.click();
    });
  }

  document.getElementById("saveBtn").addEventListener("click", saveImage);
  document.getElementById("resetBtn").addEventListener("click", () => location.reload());

  createDeck();

/* =========================
   MODE + PHOTO + STICKERS
   ========================= */
const cardCanvas = document.getElementById("cardCanvas");
const decorLayer = document.getElementById("decorLayer");
const photoFrame = document.getElementById("photoFrame");
const userPhoto = document.getElementById("userPhoto");
const modeSelect = document.getElementById("modeSelect");
const photoInput = document.getElementById("photoInput");
const photoInputWrap = document.getElementById("photoInputWrap");
const stickerSelect = document.getElementById("stickerSelect");
const stickerSize = document.getElementById("stickerSize");
const placeStickerBtn = document.getElementById("placeStickerBtn");
const clearStickersBtn = document.getElementById("clearStickersBtn");

const stickers = [];

function setMode(mode) {
  const isHybrid = mode === "hybrid";
  cardCanvas.dataset.mode = mode;

  // Show/hide the photo upload control
  photoInputWrap.style.display = isHybrid ? "inline-flex" : "none";

  if (!isHybrid) {
    // Decor mode: fully clear photo + hide image so it never shows in capture
    userPhoto.removeAttribute("src");
    userPhoto.style.display = "none";
    photoInput.value = "";
  } else {
    // Hybrid mode: show frame, show image only if it exists
    userPhoto.style.display = userPhoto.src ? "block" : "none";
  }
}

// Bind mode change ONCE (not inside setMode)
modeSelect.addEventListener("change", (e) => setMode(e.target.value));
setMode(modeSelect.value);

// Bind photo upload ONCE
photoInput.addEventListener("change", (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;

  userPhoto.src = URL.createObjectURL(file);
  userPhoto.style.display = "block";
});

function pctFromPx(x, y) {
  const r = decorLayer.getBoundingClientRect();
  return { xPct: x / r.width, yPct: y / r.height };
}
function pxFromPct(xPct, yPct) {
  const r = decorLayer.getBoundingClientRect();
  return { x: xPct * r.width, y: yPct * r.height };
}

function clampToCanvas(x, y, el) {
  const host = decorLayer.getBoundingClientRect();
  const rect = el.getBoundingClientRect();
  const halfW = rect.width / 2;
  const halfH = rect.height / 2;
  return {
    x: Math.max(halfW, Math.min(host.width - halfW, x)),
    y: Math.max(halfH, Math.min(host.height - halfH, y)),
  };
}

function removeSticker(id) {
  const idx = stickers.findIndex((s) => s.id === id);
  if (idx !== -1) stickers.splice(idx, 1);
  const el = decorLayer.querySelector(`[data-id="${id}"]`);
  if (el) el.remove();
}

function addStickerAtPx(x, y) {
  const emoji = stickerSelect.value || "ü©∑";
  const size = Number(stickerSize.value || 34);

  const el = document.createElement("div");
  el.className = "sticker";
  el.textContent = emoji;
  el.style.fontSize = size + "px";

  const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
  el.dataset.id = id;

  // model
  const s = {
    id,
    emoji,
    sizePx: size,
    xPct: 0.5,
    yPct: 0.5,
    rot: 0,     // degrees
    scale: 1
  };
  stickers.push(s);

  decorLayer.appendChild(el);

  // place
  const host = decorLayer.getBoundingClientRect();
  const clamped = clampToCanvas(x, y, el);
  el.style.left = clamped.x + "px";
  el.style.top = clamped.y + "px";
  s.xPct = clamped.x / host.width;
  s.yPct = clamped.y / host.height;

  applyTransform(el, s);
  makeTransformable(el, s);

  // Right click delete (desktop)
  el.addEventListener("contextmenu", (ev) => {
    ev.preventDefault();
    removeSticker(id);
  });
}

function applyTransform(el, s) {
  el.style.transform = `translate(-50%,-50%) rotate(${s.rot}deg) scale(${s.scale})`;
}

function makeTransformable(el, s) {
  let dragging = false;

  // desktop rotation mode: hold ALT and drag
  let rotateMode = false;
  let startAngle = 0;
  let startRot = 0;

  // two-finger gesture
  let gestureActive = false;
  let startDist = 0;
  let startGestureAngle = 0;
  let startScale = 1;

  const getCenter = () => {
    const r = el.getBoundingClientRect();
    return { cx: r.left + r.width / 2, cy: r.top + r.height / 2 };
  };

  function angleBetween(p1, p2) {
    return Math.atan2(p2.y - p1.y, p2.x - p1.x) * (180 / Math.PI);
  }

  function distBetween(p1, p2) {
    const dx = p2.x - p1.x;
    const dy = p2.y - p1.y;
    return Math.sqrt(dx*dx + dy*dy);
  }

  function onDown(e) {
    e.preventDefault();
    e.stopPropagation();
    el.setPointerCapture?.(e.pointerId);

    dragging = true;
    rotateMode = e.altKey === true;

    if (rotateMode) {
      const { cx, cy } = getCenter();
      startAngle = angleBetween({ x: cx, y: cy }, { x: e.clientX, y: e.clientY });
      startRot = s.rot;
    }

    el.style.cursor = "grabbing";
  }

  function onMove(e) {
    if (!dragging) return;

    const host = decorLayer.getBoundingClientRect();

    if (rotateMode) {
      const { cx, cy } = getCenter();
      const a = angleBetween({ x: cx, y: cy }, { x: e.clientX, y: e.clientY });
      s.rot = startRot + (a - startAngle);
      applyTransform(el, s);
      return;
    }

    const x = e.clientX - host.left;
    const y = e.clientY - host.top;
    const clamped = clampToCanvas(x, y, el);

    el.style.left = clamped.x + "px";
    el.style.top = clamped.y + "px";
    s.xPct = clamped.x / host.width;
    s.yPct = clamped.y / host.height;
  }

  function onUp(e) {
    dragging = false;
    rotateMode = false;
    el.releasePointerCapture?.(e.pointerId);
    el.style.cursor = "grab";
  }

  // Multi-touch gesture: rotate + pinch scale (iOS/iPad)
  function onTouchStart(e) {
    if (e.touches.length === 2) {
      e.preventDefault();
      e.stopPropagation();
      gestureActive = true;

      const p1 = { x: e.touches[0].clientX, y: e.touches[0].clientY };
      const p2 = { x: e.touches[1].clientX, y: e.touches[1].clientY };

      startDist = distBetween(p1, p2);
      startGestureAngle = angleBetween(p1, p2);
      startScale = s.scale;
      startRot = s.rot;
    }
  }

  function onTouchMove(e) {
    if (!gestureActive || e.touches.length !== 2) return;
    e.preventDefault();

    const p1 = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    const p2 = { x: e.touches[1].clientX, y: e.touches[1].clientY };

    const d = distBetween(p1, p2);
    const a = angleBetween(p1, p2);

    // scale (clamp scale)
    const ratio = d / Math.max(1, startDist);
    s.scale = Math.max(0.4, Math.min(3, startScale * ratio));

    // rotate
    s.rot = startRot + (a - startGestureAngle);

    applyTransform(el, s);
  }

  function onTouchEnd(e) {
    if (e.touches.length < 2) gestureActive = false;
  }

  el.addEventListener("pointerdown", onDown);
  window.addEventListener("pointermove", onMove);
  window.addEventListener("pointerup", onUp);

  el.addEventListener("touchstart", onTouchStart, { passive: false });
  el.addEventListener("touchmove", onTouchMove, { passive: false });
  el.addEventListener("touchend", onTouchEnd);
  el.style.cursor = "grab";
}

// Tap/Click empty space to place sticker
decorLayer.addEventListener("pointerdown", (e) => {
  if (e.target.classList?.contains("sticker")) return;
  const r = decorLayer.getBoundingClientRect();
  addStickerAtPx(e.clientX - r.left, e.clientY - r.top);
});

placeStickerBtn.addEventListener("click", () => {
  const r = decorLayer.getBoundingClientRect();
  addStickerAtPx(r.width / 2, r.height / 2);
});

clearStickersBtn.addEventListener("click", () => {
  stickers.length = 0;
  decorLayer.innerHTML = "";
});

function rerenderFromModel() {
  const host = decorLayer.getBoundingClientRect();

  for (const s of stickers) {
    let el = decorLayer.querySelector(`[data-id="${s.id}"]`);
    if (!el) {
      el = document.createElement("div");
      el.className = "sticker";
      el.dataset.id = s.id;
      el.textContent = s.emoji;
      decorLayer.appendChild(el);
      makeTransformable(el, s);

      el.addEventListener("contextmenu", (ev) => {
        ev.preventDefault();
        removeSticker(s.id);
      });
    }

    el.style.fontSize = s.sizePx + "px";
    el.style.left = (s.xPct * host.width) + "px";
    el.style.top  = (s.yPct * host.height) + "px";
    applyTransform(el, s);
  }
}

window.addEventListener("resize", rerenderFromModel);

</script>
</body>
</html>
